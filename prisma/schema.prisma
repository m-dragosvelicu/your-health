// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * Existing models (unchanged)
 * =========================
 */

model Post {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdBy   User   @relation(fields: [createdById], references: [id])
  createdById String

  @@index([name])
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  access_token             String?
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  posts         Post[]

  credentials Credentials?

  // reverse relations (virtual, no columns added)
  labReports   LabReport[]
  measurements Measurement[]
  files        StorageObject[]
  analyses     ReportAnalysis[]
  auditLogs    AuditLog[]
}

model Credentials {
  id           String   @id @default(cuid())
  userId       String   @unique
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
}

model AuthAttempt {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  email String?
  ip    String?

  action  String // "login" | "register" | "set-password"
  success Boolean

  @@index([email, action, createdAt])
  @@index([ip, action, createdAt])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/**
 * =========================
 * NEW: Enums
 * =========================
 */

enum StorageProvider {
  LOCAL
  S3
  GCS
}

enum LabReportStatus {
  PENDING
  OCR_PROCESSING
  OCR_FAILED
  PARSED
  READY
}

enum BiomarkerCategory {
  CBC
  METABOLIC
  LIPIDS
  RENAL
  LIVER
  THYROID
  HORMONE
  VITAMINS
  INFLAMMATION
  OTHER
}

enum MeasurementComparator {
  LT
  LTE
  EQ
  GTE
  GT
  APPROX
}

enum MeasurementFlag {
  LOW
  HIGH
  NORMAL
  CRITICAL_LOW
  CRITICAL_HIGH
  ABNORMAL
  UNKNOWN
}

enum MeasurementSource {
  OCR
  MANUAL
  EXTERNAL
}

enum OcrJobStatus {
  QUEUED
  RUNNING
  SUCCEEDED
  FAILED
}

enum AnalysisStatus {
  PENDING
  RUNNING
  FAILED
  DONE
}

enum AuditAction {
  LOGIN
  LOGOUT
  PASSWORD_CHANGE
  LAB_REPORT_UPLOAD
  LAB_REPORT_DELETE
  LAB_REPORT_VIEW
  MEASUREMENT_CREATE
  MEASUREMENT_UPDATE
  MEASUREMENT_DELETE
  AI_ANALYSIS_RUN
  SHARE_LINK_CREATE
  SHARE_LINK_REVOKE
}

/**
 * =========================
 * NEW: Storage / Files
 * =========================
 */

model StorageObject {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Where/how itâ€™s stored
  provider StorageProvider @default(LOCAL)
  bucket   String?
  key      String // object key or local path
  url      String? // optional public URL

  // File metadata
  mimeType  String?
  size      Int?
  sha256    String?
  width     Int?
  height    Int?
  pageCount Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // reverse relations
  labReportsAsSource LabReport[]   @relation("LabReportFile")
  measurements       Measurement[] @relation("MeasurementFile")

  @@index([userId, createdAt])
  @@index([provider, bucket, key])
}

/**
 * =========================
 * NEW: Lab Reports + OCR
 * =========================
 */

model LabReport {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title           String?
  providerName    String?
  accessionNumber String?
  orderId         String?

  collectedAt DateTime?
  receivedAt  DateTime?

  status LabReportStatus @default(PENDING)

  // original uploaded file
  sourceFileId String?
  sourceFile   StorageObject? @relation("LabReportFile", fields: [sourceFileId], references: [id], onDelete: SetNull)

  // attachments
  ocr          LabReportOcr?
  measurements Measurement[]
  analyses     ReportAnalysis[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId, createdAt])
  @@index([status, createdAt])
}

model LabReportOcr {
  id          String    @id @default(cuid())
  labReportId String    @unique
  labReport   LabReport @relation(fields: [labReportId], references: [id], onDelete: Cascade)

  engine        String?
  confidenceAvg Float?
  pageCount     Int?

  rawText    String @db.Text
  blocksJson Json? // structured blocks/lines/cells if available

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/**
 * =========================
 * NEW: Biomarkers & Measurements
 * =========================
 */

model Biomarker {
  id            String            @id @default(cuid())
  slug          String            @unique
  name          String
  category      BiomarkerCategory @default(OTHER)
  canonicalUnit String

  // optional defaults (general and sex-specific)
  defaultRefLow  Decimal? @db.Decimal(20, 10)
  defaultRefHigh Decimal? @db.Decimal(20, 10)
  maleRefLow     Decimal? @db.Decimal(20, 10)
  maleRefHigh    Decimal? @db.Decimal(20, 10)
  femaleRefLow   Decimal? @db.Decimal(20, 10)
  femaleRefHigh  Decimal? @db.Decimal(20, 10)

  description String?
  sortOrder   Int?

  measurements Measurement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category, name])
}

model Measurement {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  biomarkerId String
  biomarker   Biomarker @relation(fields: [biomarkerId], references: [id], onDelete: Restrict)

  labReportId String?
  labReport   LabReport? @relation(fields: [labReportId], references: [id], onDelete: SetNull)

  measuredAt DateTime @default(now())

  // values
  value           Decimal?              @db.Decimal(30, 12) // raw numeric if parseable
  inCanonicalUnit Decimal?              @db.Decimal(30, 12) // converted for trends
  comparator      MeasurementComparator @default(EQ)
  rawValueText    String? // e.g., "<5"

  unit          String
  referenceLow  Decimal?        @db.Decimal(30, 12)
  referenceHigh Decimal?        @db.Decimal(30, 12)
  referenceText String?
  flag          MeasurementFlag @default(UNKNOWN)

  source        MeasurementSource @default(OCR)
  ocrConfidence Float?

  // provenance
  provenanceFileId String?
  provenanceFile   StorageObject? @relation("MeasurementFile", fields: [provenanceFileId], references: [id], onDelete: SetNull)

  note String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId, measuredAt])
  @@index([biomarkerId, measuredAt])
  @@index([labReportId])
}

/**
 * =========================
 * NEW: AI Analyses
 * =========================
 */

model ReportAnalysis {
  id String @id @default(cuid())

  labReportId String
  labReport   LabReport @relation(fields: [labReportId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status        AnalysisStatus @default(PENDING)
  model         String?
  promptVersion String?

  summaryMarkdown String?  @db.Text
  findings        Json?
  riskTags        String[] // postgres text[]

  tokensPrompt     Int?
  tokensCompletion Int?
  errorMessage     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([labReportId, createdAt])
}

/**
 * =========================
 * NEW: Audit trail
 * =========================
 */

model AuditLog {
  id     String  @id @default(cuid())
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  action    AuditAction
  ip        String?
  userAgent String?

  subjectType String? // e.g., "LabReport", "Measurement"
  subjectId   String?

  metadata  Json?
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
  @@index([action, createdAt])
}

generator erd {
  provider = "prisma-erd-generator"
  output   = "./ERD.svg"
}
